/**
 * GTM Traffic Source Classifier & Persister - External Script Version
 * ===================================================================
 *
 * This is the external script version for CSP-compliant environments.
 * Load this file via GTM Custom HTML Tag: <script src="/js/gtm-traffic-source.js"></script>
 *
 * CSP Configuration Required:
 * - script-src 'self' https://yourdomain.com
 * - object-src 'none'
 * - base-uri 'self'
 *
 * @author Florian Pankarter / MEDIAFAKTUR
 * @version 1.0.0
 * @license MIT
 * @see https://github.com/mediafaktur/gtm-traffic-source
 */

(function () { 'use strict'; var hasURLSearchParams = typeof window.URLSearchParams !== 'undefined'; var hasURLConstructor = typeof window.URL !== 'undefined'; var hasAddEventListener = typeof document.addEventListener !== 'undefined'; var hasCustomEvent = typeof window.CustomEvent !== 'undefined'; var hasStringIncludes = typeof String.prototype.includes === 'function'; var hasArrayIncludes = typeof Array.prototype.includes === 'function'; function getParam(name, search) { if (!search) search = window.location.search; var regex = new RegExp('[?&]' + name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + '=([^&#]*)', 'i'); var results = regex.exec(search); if (!results) return null; try { return decodeURIComponent(results[1].replace(/\+/g, ' ')); } catch (e) { return results[1].replace(/\+/g, ' '); } } function createURL(url, base) { if (hasURLConstructor) { return new URL(url, base); } var a = document.createElement('a'); if (base) { var b = document.createElement('a'); b.href = base; a.href = b.href; } a.href = url; return { href: a.href, hostname: a.hostname || '', search: a.search || '' }; } function addEvent(element, event, handler) { if (hasAddEventListener) { element.addEventListener(event, handler, false); } else if (element.attachEvent) { element.attachEvent('on' + event, handler); } } function removeEvent(element, event, handler) { if (hasAddEventListener) { element.removeEventListener(event, handler, false); } else if (element.detachEvent) { element.detachEvent('on' + event, handler); } } if (!hasStringIncludes) { String.prototype.includes = function (search, start) { if (typeof start !== 'number') { start = 0; } if (start + search.length > this.length) { return false; } else { return this.indexOf(search, start) !== -1; } }; } if (!hasArrayIncludes) { Array.prototype.includes = function (searchElement, fromIndex) { if (this == null) { throw new TypeError('Array.prototype.includes called on null or undefined'); } var O = Object(this); var len = parseInt(O.length) || 0; if (len === 0) { return false; } var n = parseInt(fromIndex) || 0; var k = n >= 0 ? n : Math.max(len + n, 0); while (k < len) { if (O[k] === searchElement) { return true; } k++; } return false; } } if (!hasCustomEvent) { var CustomEvent = function (event, params) { params = params || { bubbles: false, cancelable: false, detail: null }; var evt = document.createEvent('CustomEvent'); evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail); return evt; }; CustomEvent.prototype = (window.Event && window.Event.prototype) || {}; window.CustomEvent = CustomEvent; } function debugLog(level, message, data) { if (typeof CONFIG !== 'undefined' && CONFIG.DEBUG && window.console && window.console[level]) { if (data) { window.console[level](message, data); } else { window.console[level](message); } } } debugLog('log', 'GTM Traffic Source - Browser Compatibility:', { URLSearchParams: hasURLSearchParams, URLConstructor: hasURLConstructor, addEventListener: hasAddEventListener, CustomEvent: hasCustomEvent, StringIncludes: hasStringIncludes, ArrayIncludes: hasArrayIncludes, fallbacks: !hasURLSearchParams || !hasURLConstructor || !hasAddEventListener || !hasStringIncludes || !hasArrayIncludes }); var CONFIG = { DEBUG: false, STORAGE_PREFIX: 'ms_ts', ENTRY_CAPTURED_PREFIX: 'ms_entryCaptured', CURRENT_ALIAS: 'ms_ts_current', PRIORITIES: ['click_id', 'utm', 'organic', 'social', 'referral', 'direct'], CHANNEL_GROUPS: { 'direct': 'Direct', 'paid_search': 'Paid Search', 'paid_social': 'Paid Social', 'paid_shopping': 'Paid Shopping', 'paid_video': 'Paid Video', 'display': 'Display', 'display_remarketing': 'Display', 'organic_search': 'Organic Search', 'organic_social': 'Organic Social', 'organic_shopping': 'Organic Shopping', 'organic_video': 'Organic Video', 'email': 'Email', 'affiliate': 'Affiliates', 'referral': 'Referral', 'audio': 'Audio', 'sms': 'SMS', 'mobile_push': 'Mobile Push Notifications', 'cross_network': 'Cross-network', 'unassigned': 'Unassigned' }, SEARCH_ENGINES: ['google.com', 'google.de', 'google.co.uk', 'google.fr', 'google.es', 'bing.com', 'yahoo.com', 'duckduckgo.com', 'yandex.com', 'baidu.com', 'ask.com', 'aol.com', 'ecosia.com', 'qwant.com'], MAIL_CLIENTS: ['mail', 't-online', 'gmail', 'outlook', 'yahoo-mail', 'hotmail'], DEBUG_TOOLS: ['tagassistant.google.com', 'www.google.com/tagmanager', 'tagmanager.google.com', 'analytics.google.com', 'search.google.com/test', 'developers.google.com'], SOCIAL_PLATFORMS: ['facebook.com', 'instagram.com', 'twitter.com', 'x.com', 'linkedin.com', 'pinterest.com', 'tiktok.com', 'youtube.com', 'snapchat.com', 'reddit.com', 'badoo.com', 'whatsapp.com', 'dailymotion.com', 'disneyplus.com', 'netflix.com', 'vimeo.com', 'twitch.com'], SELF_REFERRAL_DOMAINS: [] }; function safeStorageGet(key, storage) { try { return storage.getItem(key); } catch (e) { return null; } } function safeStorageSet(key, value, storage) { try { storage.setItem(key, value); return true; } catch (e) { return false; } } function getCurrentTimestamp() { return new Date().getTime(); } function generateId() { return 'ts_' + getCurrentTimestamp() + '_' + Math.random().toString(36).substring(2, 8); } function getCurrentUrl() { return window.location.href; } function getReferrer() { return document.referrer || ''; } function getUrlParams() { return { get: function (name) { return getParam(name); } }; } function getReferrerDomain() { try { if (!document.referrer) return ''; return createURL(document.referrer).hostname; } catch (e) { return ''; } } function isSelfReferral(refDomain, currentDomain) { if (!refDomain) return false; for (var i = 0; i < CONFIG.SELF_REFERRAL_DOMAINS.length; i++) { if (refDomain === CONFIG.SELF_REFERRAL_DOMAINS[i]) return true; } var refETLD = getETLD1(refDomain); var currentETLD = getETLD1(currentDomain); return refETLD === currentETLD && refETLD !== ''; } function getETLD1(hostname) { try { var parts = hostname.split('.'); return parts.length >= 2 ? parts.slice(-2).join('.') : hostname; } catch (e) { return hostname; } } function classifyTrafficSource(timestamp) { var url = getCurrentUrl(); var referrer = getReferrer(); var refDomain = getReferrerDomain(); var currentDomain = window.location.hostname; var params = getUrlParams(); timestamp = timestamp || getCurrentTimestamp(); var result = { id: generateId(), timestamp: timestamp, entry_url: url, referrer: referrer, method: 'unknown', channel_group: 'unknown', source: 'unknown', medium: 'unknown', campaign: '', term: '', content: '', ad_platform: '', click_id: '', raw_params: {}, classifier_version: '1.0.0', source_of_truth: 'unknown' }; var utmSource = (params.get('utm_source') || '').trim(); var utmMedium = (params.get('utm_medium') || '').trim(); var utmCampaign = (params.get('utm_campaign') || '').trim(); var utmTerm = (params.get('utm_term') || '').trim(); var utmContent = (params.get('utm_content') || '').trim(); result.raw_params = { utm_source: utmSource, utm_medium: utmMedium, utm_campaign: utmCampaign, utm_term: utmTerm, utm_content: utmContent }; var _s = utmSource.toLowerCase(); var _m = normalizeUTMMedium(utmMedium.toLowerCase()); var _c = utmCampaign.toLowerCase(); var clickId = params.get('gclid') || params.get('gbraid') || params.get('wbraid') || params.get('msclkid') || params.get('fbclid') || params.get('ttclid') || params.get('li_fat_id') || params.get('twclid') || ''; if (clickId) { result.method = 'click_id'; result.click_id = clickId; result.source_of_truth = 'click_id'; if (params.get('gclid')) { result.channel_group = 'paid_search'; result.source = 'google'; result.medium = 'cpc'; result.ad_platform = 'google_ads'; } else if (params.get('gbraid')) { result.channel_group = 'paid_search'; result.source = 'google'; result.medium = 'cpc'; result.ad_platform = 'google_ads'; } else if (params.get('wbraid')) { result.channel_group = 'paid_search'; result.source = 'google'; result.medium = 'cpc'; result.ad_platform = 'google_ads'; } else if (params.get('msclkid')) { result.channel_group = 'paid_search'; result.source = 'microsoft'; result.medium = 'cpc'; result.ad_platform = 'microsoft_ads'; } else if (params.get('fbclid')) { result.channel_group = 'paid_social'; result.source = 'facebook'; result.medium = 'paid_social'; result.ad_platform = 'facebook_ads'; } else if (params.get('ttclid')) { result.channel_group = 'paid_social'; result.source = 'tiktok'; result.medium = 'paid_social'; result.ad_platform = 'tiktok_ads'; } else if (params.get('li_fat_id')) { result.channel_group = 'paid_social'; result.source = 'linkedin'; result.medium = 'paid_social'; result.ad_platform = 'linkedin_ads'; } else if (params.get('twclid')) { result.channel_group = 'paid_social'; result.source = 'twitter'; result.medium = 'paid_social'; result.ad_platform = 'twitter_ads'; } if (utmSource && isPlausibleSource(_s, result.channel_group)) { result.source = utmSource; } if (utmCampaign) result.campaign = utmCampaign; if (utmTerm) result.term = utmTerm; if (utmContent) result.content = utmContent; var conflictReason = ''; if (utmSource && !isPlausibleSource(_s, result.channel_group)) { conflictReason = 'source_conflict'; } if (conflictReason) { result.plausibility_conflict = true; result.conflict_reason = conflictReason; } return result; } if (utmSource) { result.method = 'utm'; result.channel_group = 'unknown'; result.source = utmSource; result.medium = utmMedium || 'unknown'; result.campaign = utmCampaign; result.term = utmTerm; result.content = utmContent; result.source_of_truth = 'utm'; if (_m === 'paid' && isSocialSource(_s) && !isVideoPlatform(_s)) { result.soft_alias_used = true; result.medium = 'paid_social'; } if (_m === 'paid_social' || (_m === 'paid' && isSocialSource(_s) && !isVideoPlatform(_s))) { result.channel_group = 'paid_social'; result.medium = 'paid_social'; } if (_s === 'facebook' && _m === 'cpc') { result.plausibility_conflict = true; result.conflict_reason = 'hard_conflict_source_medium'; } if (_s === 'google' && _m === 'social') { result.plausibility_conflict = true; result.conflict_reason = 'hard_conflict_source_medium'; } if (_s === 'linkedin' && _m === 'cpc') { result.plausibility_conflict = true; result.conflict_reason = 'hard_conflict_source_medium'; } if (utmMedium) { var medium = _m; var source = _s; var campaign = _c; var isBrand = campaign.includes('brand') || campaign.includes('branded'); var classifiedExact = false; if (medium === 'paid_search') { result.channel_group = 'paid_search'; result.medium = isBrand ? 'paid-brand' : 'paid-generic'; classifiedExact = true; } else if (medium === 'organic_search') { result.channel_group = 'organic_search'; result.medium = 'organic'; classifiedExact = true; } else if (medium === 'display_remarketing') { result.channel_group = 'display_remarketing'; result.medium = 'display_remarketing'; classifiedExact = true; } else if (medium === 'display') { result.channel_group = 'display'; result.medium = 'display'; classifiedExact = true; } else if (medium === 'email') { result.channel_group = 'email'; result.medium = 'email'; classifiedExact = true; } else if (medium === 'paid_social') { result.channel_group = 'paid_social'; result.medium = 'paid_social'; classifiedExact = true; } else if (medium === 'organic_social') { result.channel_group = 'organic_social'; result.medium = 'social'; classifiedExact = true; } if (classifiedExact) { if (!isValidUTMCombination(_s, medium, _c)) { result.medium = 'unknown'; result.missing_medium = true; debugLog('warn', 'UTM validation failed for exact match, medium set to unknown', { source: _s, medium: medium, campaign: _c }); } return result; } if (medium.includes('cpc') || medium.includes('ppc')) { if (source.includes('alibaba') || source.includes('amazon') || source.includes('google shopping') || source.includes('shopify') || source.includes('etsy') || source.includes('ebay') || source.includes('stripe') || source.includes('walmart') || campaign.includes('shop') || campaign.includes('shopping')) { result.channel_group = 'paid_shopping'; } else if (source.includes('baidu') || source.includes('bing') || source.includes('duckduckgo') || source.includes('ecosia') || source.includes('google') || source.includes('yahoo') || source.includes('yandex')) { result.channel_group = 'paid_search'; if (isBrand) result.medium = 'paid-brand'; else result.medium = 'paid-generic'; } else if (source.includes('badoo') || source.includes('facebook') || source.includes('fb') || source.includes('instagram') || source.includes('linkedin') || source.includes('pinterest') || source.includes('tiktok') || source.includes('twitter') || source.includes('whatsapp')) { result.channel_group = 'paid_social'; } else if (source.includes('dailymotion') || source.includes('disneyplus') || source.includes('netflix') || source.includes('youtube') || source.includes('vimeo') || source.includes('twitch')) { result.channel_group = 'paid_video'; } else if (campaign.includes('cross-network')) { result.channel_group = 'cross_network'; } else { result.channel_group = 'paid_search'; if (isBrand) result.medium = 'paid-brand'; else result.medium = 'paid-generic'; } } else if (medium.includes('disp') || medium.includes('banner') || medium.includes('expandable') || medium.includes('interstitial') || medium.includes('cpm') || source.includes('criteo')) { if (campaign.includes('remarketing') || source.includes('retargeting') || medium.includes('retargeting')) { result.channel_group = 'display_remarketing'; } else { result.channel_group = 'display'; } } else if (medium.includes('email') || medium.includes('e-mail') || medium.includes('e_mail') || source.includes('email') || source.includes('e-mail') || source.includes('e_mail')) { result.channel_group = 'email'; } else if (medium.includes('affiliate')) { result.channel_group = 'affiliate'; } else if (medium.includes('push') || medium.includes('mobile') || medium.includes('notification')) { result.channel_group = 'mobile_push'; } else if (medium.includes('audio')) { result.channel_group = 'audio'; } else if (medium.includes('sms')) { result.channel_group = 'sms'; } else if (medium.includes('social') || medium.includes('social_media') || medium.includes('social-network') || medium.includes('sm')) { result.channel_group = 'organic_social'; } else if (medium.includes('video')) { result.channel_group = 'organic_video'; } else { result.channel_group = 'unassigned'; } } if (result.channel_group === 'unassigned' || result.channel_group === 'unknown') { result.missing_medium = true; if (isVideoPlatform(_s)) { result.channel_group = 'organic_video'; result.medium = 'unknown'; } else if (isSocialSource(_s)) { result.channel_group = 'organic_social'; result.medium = 'unknown'; } else if (/^(google|bing|yahoo|yandex|duckduckgo|baidu)$/.test(_s)) { result.channel_group = 'organic_search'; result.medium = 'unknown'; } debugLog('info', 'Source-driven fallback applied (missing medium)', { source: _s, channel_group: result.channel_group, missing_medium: true }); } if (!utmMedium || !isValidUTMCombination(_s, _m, _c)) { result.medium = 'unknown'; result.missing_medium = true; debugLog('warn', 'UTM validation failed, medium set to unknown', { source: _s, medium: _m, campaign: _c }); } return result; } if (isSearchEngine(refDomain) && !isDebugTool(refDomain)) { result.method = 'organic'; result.source = getSearchEngineName(refDomain); result.medium = 'organic'; result.source_of_truth = 'referrer'; var source = result.source.toLowerCase(); if (source.includes('alibaba') || source.includes('amazon') || source.includes('google shopping') || source.includes('shopify') || source.includes('etsy') || source.includes('ebay') || source.includes('stripe') || source.includes('walmart')) { result.channel_group = 'organic_shopping'; } else if (source.includes('dailymotion') || source.includes('disneyplus') || source.includes('netflix') || source.includes('youtube') || source.includes('vimeo') || source.includes('twitch')) { result.channel_group = 'organic_video'; } else { result.channel_group = 'organic_search'; } var searchTerm = extractSearchTerm(referrer, refDomain); if (searchTerm) result.term = searchTerm; return result; } if (isSocialPlatform(refDomain)) { result.method = 'social'; result.source = getSocialPlatformName(refDomain); result.medium = 'social'; result.source_of_truth = 'referrer'; var source = result.source.toLowerCase(); if (source.includes('dailymotion') || source.includes('disneyplus') || source.includes('netflix') || source.includes('youtube') || source.includes('vimeo') || source.includes('twitch')) { result.channel_group = 'organic_video'; } else { result.channel_group = 'organic_social'; } return result; } if (isMailClient(refDomain)) { result.method = 'mail'; result.channel_group = 'email'; result.source = 'mail'; result.medium = 'email'; result.source_of_truth = 'referrer'; return result; } if (refDomain && !isSelfReferral(refDomain, currentDomain)) { result.method = 'referral'; result.channel_group = 'referral'; result.source = refDomain; result.medium = 'referral'; result.source_of_truth = 'referrer'; return result; } result.method = 'direct'; result.channel_group = 'direct'; result.source = '(direct)'; result.medium = '(none)'; result.source_of_truth = 'direct'; return result; } function isValidUTMCombination(source, medium, campaign) { if (!source || !medium) return false; var bad = ['', 'null', 'undefined', 'none', 'unknown']; if (bad.indexOf(source) !== -1 || bad.indexOf(medium) !== -1) return false; var s = source; var m = medium; var isSearchSrc = /^(google|bing|yahoo|yandex|duckduckgo|baidu)$/.test(s); var isSocialSrc = /^(facebook|fb|instagram|ig|linkedin|tiktok|twitter|x|snapchat|pinterest)$/.test(s); var isVideoSrc = /^(youtube|vimeo|twitch|dailymotion|disneyplus|netflix)$/.test(s); if (isSearchSrc && (m === 'paid_social' || m === 'organic_social' || m === 'email' || m === 'display')) return false; if (isSocialSrc && (m === 'paid_search' || m === 'organic_search' || m === 'email')) return false; if (isVideoSrc && (m === 'paid_search' || m === 'organic_search' || m === 'email')) return false; if (m === 'paid_search' && /shop|shopping|pla/.test(campaign)) return true; return true; } function isSearchEngine(domain) { for (var i = 0; i < CONFIG.SEARCH_ENGINES.length; i++) { if (domain.includes(CONFIG.SEARCH_ENGINES[i])) return true; } return false; } function isDebugTool(domain) { for (var i = 0; i < CONFIG.DEBUG_TOOLS.length; i++) { if (domain.includes(CONFIG.DEBUG_TOOLS[i])) return true; } return false; } function getSearchEngineName(domain) { if (domain.includes('google')) return 'google'; if (domain.includes('bing')) return 'bing'; if (domain.includes('yahoo')) return 'yahoo'; if (domain.includes('duckduckgo')) return 'duckduckgo'; if (domain.includes('yandex')) return 'yandex'; if (domain.includes('baidu')) return 'baidu'; if (domain.includes('ask')) return 'ask'; if (domain.includes('aol')) return 'aol'; if (domain.includes('ecosia')) return 'ecosia'; if (domain.includes('qwant')) return 'qwant'; return domain; } function isSocialPlatform(domain) { for (var i = 0; i < CONFIG.SOCIAL_PLATFORMS.length; i++) { if (domain.includes(CONFIG.SOCIAL_PLATFORMS[i])) return true; } return false; } function isMailClient(domain) { for (var i = 0; i < CONFIG.MAIL_CLIENTS.length; i++) { if (domain.includes(CONFIG.MAIL_CLIENTS[i])) return true; } return false; } function normalizeUTMMedium(medium) { if (!medium) return medium; if (medium === 'paidsocial' || medium === 'social_paid' || medium === 'socialpaid') { return 'paid_social'; } if (medium === 'social' || medium === 'social_media' || medium === 'socialmedia') { return 'organic_social'; } if (medium === 'cpc' || medium === 'ppc' || medium === 'paidsearch' || medium === 'search_paid' || medium === 'searchpaid') { return 'paid_search'; } if (medium === 'organicsearch' || medium === 'search_organic' || medium === 'searchorganic') { return 'organic_search'; } if (medium === 'display' || medium === 'banner' || medium === 'banners') { return 'display'; } if (medium === 'remarketing' || medium === 'retargeting') { return 'display_remarketing'; } if (medium === 'email' || medium === 'e-mail' || medium === 'e_mail' || medium === 'mail') { return 'email'; } return medium; } function isSocialSource(utmSource) { var source = utmSource.toLowerCase(); return source.includes('facebook') || source.includes('instagram') || source.includes('linkedin') || source.includes('tiktok') || source.includes('twitter') || source.includes('pinterest') || source.includes('snapchat'); } function isVideoPlatform(utmSource) { var source = utmSource.toLowerCase(); return source.includes('youtube') || source.includes('vimeo') || source.includes('twitch') || source.includes('dailymotion') || source.includes('disneyplus') || source.includes('netflix'); } function isPlausibleSource(utmSource, channelGroup) { var source = utmSource.toLowerCase(); if (channelGroup === 'paid_search' && (source.includes('facebook') || source.includes('instagram') || source.includes('linkedin') || source.includes('tiktok'))) { return false; } if (channelGroup === 'paid_social' && (source.includes('google') || source.includes('bing') || source.includes('yahoo'))) { return false; } if (channelGroup === 'paid_shopping' && !(source.includes('amazon') || source.includes('google') || source.includes('shop') || source.includes('ebay'))) { return false; } if (channelGroup === 'display' && (source.includes('google') || source.includes('bing') || source.includes('facebook') || source.includes('linkedin'))) { return false; } if (channelGroup === 'paid_video' && !(source.includes('youtube') || source.includes('vimeo') || source.includes('twitch') || source.includes('dailymotion'))) { return false; } return true; } function getSocialPlatformName(domain) { if (domain.includes('facebook')) return 'facebook'; if (domain.includes('instagram')) return 'instagram'; if (domain.includes('twitter') || domain.includes('x.com')) return 'twitter'; if (domain.includes('linkedin')) return 'linkedin'; if (domain.includes('pinterest')) return 'pinterest'; if (domain.includes('tiktok')) return 'tiktok'; if (domain.includes('youtube')) return 'youtube'; if (domain.includes('snapchat')) return 'snapchat'; if (domain.includes('reddit')) return 'reddit'; if (domain.includes('badoo')) return 'badoo'; if (domain.includes('whatsapp')) return 'whatsapp'; if (domain.includes('dailymotion')) return 'dailymotion'; if (domain.includes('disneyplus')) return 'disneyplus'; if (domain.includes('netflix')) return 'netflix'; if (domain.includes('vimeo')) return 'vimeo'; if (domain.includes('twitch')) return 'twitch'; return domain; } function extractSearchTerm(referrer, domain) { try { var url = createURL(referrer); if (domain.includes('google')) { return getParam('q', url.search) || ''; } else if (domain.includes('bing')) { return getParam('q', url.search) || ''; } else if (domain.includes('yahoo')) { return getParam('p', url.search) || ''; } else if (domain.includes('duckduckgo')) { return getParam('q', url.search) || ''; } else if (domain.includes('yandex')) { return getParam('text', url.search) || ''; } else if (domain.includes('baidu')) { return getParam('wd', url.search) || ''; } return ''; } catch (e) { return ''; } } function waitForMSID(callback, maxAttempts) { if (typeof maxAttempts === 'undefined') { maxAttempts = 50; } var attempts = 0; if (typeof window.__ms !== 'undefined' && window.__ms.sessionId) { callback(); return; } var eventHandler = function (event) { removeEvent(document, 'msid:ready', eventHandler); callback(); }; addEvent(document, 'msid:ready', eventHandler); var interval = setInterval(function () { attempts++; if (typeof window.__ms !== 'undefined' && window.__ms.sessionId) { clearInterval(interval); removeEvent(document, 'msid:ready', eventHandler); callback(); } else if (attempts >= maxAttempts) { clearInterval(interval); removeEvent(document, 'msid:ready', eventHandler); debugLog('warn', 'MSID not available after ' + maxAttempts + ' attempts'); } }, 100); } function main() { var sessionId = {{ msSessionId } }; if (!sessionId) { debugLog('warn', 'TS Classifier: No MSID session ID available'); return; } var signals = (window.__ms && window.__ms._signals) || {}; var timestamp = signals.now || getCurrentTimestamp(); var capturedKey = CONFIG.ENTRY_CAPTURED_PREFIX + ':' + sessionId; var carryKey = CONFIG.STORAGE_PREFIX + '_by_sid:' + sessionId; var alreadyCaptured = safeStorageGet(capturedKey, sessionStorage); if (alreadyCaptured) { debugLog('log', 'TS Classifier: Already captured for session', sessionId); return; } var trafficSource = null; if (signals.isStart) { debugLog('log', 'TS Classifier: New session detected, classifying...'); trafficSource = classifyTrafficSource(timestamp); } else if (signals.carryAllowed) { var carryOverData = safeStorageGet(carryKey, localStorage); if (carryOverData) { try { trafficSource = JSON.parse(carryOverData); debugLog('log', 'TS Classifier: Carrying over from previous tab'); } catch (e) { debugLog('warn', 'TS Classifier: Failed to parse carry-over data, classifying...'); trafficSource = classifyTrafficSource(); } } else { debugLog('log', 'TS Classifier: No carry-over data, classifying...'); trafficSource = classifyTrafficSource(); } } else { var co = safeStorageGet(carryKey, localStorage); if (co) { try { trafficSource = JSON.parse(co); debugLog('log', 'TS Classifier: Fallback carry-over from previous tab'); } catch (e) { debugLog('warn', 'TS Classifier: Failed to parse fallback carry-over data, classifying...'); trafficSource = classifyTrafficSource(timestamp); } } else { debugLog('log', 'TS Classifier: Fallback classification...'); trafficSource = classifyTrafficSource(timestamp); } } if (!trafficSource) { debugLog('error', 'TS Classifier: Failed to classify traffic source'); return; } if (signals.isStart) { try { sessionStorage.removeItem(CONFIG.CURRENT_ALIAS); debugLog('log', 'TS Classifier: Cleared alias for new session start'); } catch (e) { debugLog('warn', 'TS Classifier: Failed to clear alias:', e); } } var tsJson = JSON.stringify(trafficSource); safeStorageSet(CONFIG.CURRENT_ALIAS, tsJson, sessionStorage); safeStorageSet(capturedKey, 'true', sessionStorage); safeStorageSet(CONFIG.STORAGE_PREFIX + ':' + sessionId, tsJson, sessionStorage); safeStorageSet(carryKey, tsJson, localStorage); var debugInfo = { sessionId: sessionId, method: trafficSource.method, channel_group: trafficSource.channel_group, source: trafficSource.source, medium: trafficSource.medium, campaign: trafficSource.campaign }; if (trafficSource.plausibility_conflict) { debugInfo.plausibility_conflict = true; debugInfo.conflict_reason = trafficSource.conflict_reason; debugLog('warn', 'TS Classifier: Plausibility conflict detected:', { conflict_reason: trafficSource.conflict_reason, click_id: trafficSource.click_id, utm_source: trafficSource.raw_params.utm_source, utm_medium: trafficSource.raw_params.utm_medium }); } if (trafficSource.soft_alias_used) { debugInfo.soft_alias_used = true; debugLog('log', 'TS Classifier: Soft alias used - utm_medium=paid normalized to paid_social'); } debugLog('log', 'TS Classifier: Stored traffic source:', debugInfo); if (window.dataLayer) { window.dataLayer.push({ 'event': 'traffic_source_classified', 'traffic_source': trafficSource }); } }waitForMSID(main);}) ();
